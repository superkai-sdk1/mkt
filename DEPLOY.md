# MKT — Инструкция по развёртыванию

## Содержание

- [Требования](#требования)
- [Быстрая установка](#быстрая-установка)
- [Что делает скрипт](#что-делает-скрипт)
- [Команды deploy.sh](#команды-deploysh)
- [Локальная разработка](#локальная-разработка)
- [Обновление на сервере](#обновление-на-сервере)
- [Структура проекта](#структура-проекта)
- [Админ-панель](#админ-панель)
- [Настройка домена](#настройка-домена)
- [SSL-сертификат](#ssl-сертификат)
- [Устранение неполадок](#устранение-неполадок)

---

## Требования

**VPS:**
- Ubuntu 20.04 / 22.04 / 24.04 или Debian 11 / 12
- Минимум 512 МБ RAM, 1 vCPU
- Root-доступ (или sudo)
- Домен, направленный A-записью на IP сервера

**Локально (для разработки):**
- Node.js 18+
- Git

---

## Быстрая установка

Подключитесь к серверу по SSH и выполните три команды:

```bash
curl -sL https://raw.githubusercontent.com/superkai-sdk1/mkt/main/deploy.sh -o deploy.sh
chmod +x deploy.sh
sudo ./deploy.sh install
```

Скрипт задаст два вопроса:
1. **Домен** — например `site.example.com`
2. **Настроить SSL?** — введите `y` и укажите email

После завершения сайт будет доступен по вашему домену.

---

## Что делает скрипт

При команде `install` выполняется:

| Шаг | Действие |
|-----|----------|
| 1 | Обновление пакетов, установка `git`, `nginx`, `certbot`, `ufw` |
| 2 | Установка Node.js 20 LTS через NodeSource |
| 3 | Создание системного пользователя `mkt` |
| 4 | Клонирование репозитория в `/opt/mkt` |
| 5 | Установка npm-зависимостей |
| 6 | Создание systemd-сервиса с автозапуском |
| 7 | Настройка nginx как reverse proxy |
| 8 | Включение фаервола (SSH + HTTP + HTTPS) |
| 9 | Выпуск SSL-сертификата Let's Encrypt (опционально) |

---

## Команды deploy.sh

```bash
sudo ./deploy.sh install      # Полная первичная установка
sudo ./deploy.sh update       # Обновить код из GitHub
sudo ./deploy.sh domain       # Настроить/сменить домен
sudo ./deploy.sh ssl          # Установить SSL-сертификат
     ./deploy.sh status       # Статус компонентов
     ./deploy.sh logs         # Логи в реальном времени
sudo ./deploy.sh restart      # Перезапуск приложения
sudo ./deploy.sh uninstall    # Полное удаление
```

---

## Локальная разработка

```bash
git clone https://github.com/superkai-sdk1/mkt.git
cd mkt
npm install
npm start
```

Сайт: http://localhost:3000  
Админка: http://localhost:3000/admin.html

При первом входе в админку нужно создать пароль (мин. 4 символа).

---

## Обновление на сервере

### 1. Внесите изменения локально

Отредактируйте файлы, затем:

```bash
git add -A
git commit -m "Описание изменений"
git push
```

### 2. Обновите сервер

```bash
ssh user@your-server
sudo /opt/mkt/deploy.sh update
```

Скрипт:
- Создаст бэкап папки `data/`
- Подтянет последние изменения из GitHub
- Переустановит зависимости (если изменился `package.json`)
- Перезапустит сервис

> Данные (услуги, каналы, профиль, аватар, пароль) хранятся в `/opt/mkt/data/` и **не затрагиваются** при обновлении.

---

## Структура проекта

```
mkt/
├── index.html        # Главная страница (лендинг)
├── style.css         # Стили главной страницы
├── admin.html        # Админ-панель (SPA)
├── admin.css         # Стили админки
├── server.js         # Express-сервер + API
├── package.json      # Зависимости
├── sw.js             # Service Worker (PWA)
├── manifest.json     # PWA-манифест
├── favicon.svg       # Фавикон
├── icon-192.svg      # Иконка PWA 192×192
├── icon-512.svg      # Иконка PWA 512×512
├── deploy.sh         # Скрипт развёртывания
├── .gitignore
├── data/             # ← Только на сервере, в Git не попадает
│   ├── site.json     #   Данные сайта (услуги, каналы, профиль)
│   ├── auth.json     #   Хеш пароля админки
│   └── avatar.*      #   Аватар (если загружен)
```

---

## Админ-панель

Доступна по адресу `/admin.html`. Возможности:

- **Главная** — редактирование Hero-блока, заголовков секций, CTA
- **Обо мне** — имя, описание, статистика, аватар
- **Услуги** — CRUD карточек, сортировка, широкие карточки с бейджем
- **Каналы** — аналогично услугам

Авторизация через пароль (SHA-256 хеш хранится на сервере).
Админка работает как PWA — можно установить на телефон.

### API-эндпоинты

| Метод | URL | Доступ | Описание |
|-------|-----|--------|----------|
| GET | `/api/data` | Публичный | Все данные сайта |
| GET | `/api/avatar` | Публичный | Аватар |
| POST | `/api/hero` | Auth | Сохранить Hero-блок |
| POST | `/api/sections` | Auth | Сохранить заголовки секций |
| POST | `/api/cta` | Auth | Сохранить CTA-блок |
| POST | `/api/about` | Auth | Сохранить «Обо мне» |
| POST | `/api/services` | Auth | Сохранить услуги |
| POST | `/api/channels` | Auth | Сохранить каналы |
| POST | `/api/avatar` | Auth | Загрузить аватар |
| DELETE | `/api/avatar` | Auth | Удалить аватар |
| GET | `/api/auth/status` | Публичный | Есть ли пароль |
| POST | `/api/auth/setup` | Публичный* | Создать пароль |
| POST | `/api/auth/login` | Публичный | Проверить пароль |
| POST | `/api/auth/reset` | Auth | Сбросить пароль |

*Только если пароль ещё не создан.

Авторизованные запросы используют заголовок: `Authorization: Bearer <sha256-hash>`

---

## Настройка домена

### 1. DNS

В панели вашего регистратора домена создайте A-запись:

```
Тип: A
Имя: @ (или поддомен, например admin)
Значение: IP-адрес вашего VPS
TTL: 300
```

### 2. Настройка в nginx

```bash
sudo /opt/mkt/deploy.sh domain
```

Введите домен. Nginx автоматически будет проксировать запросы к приложению.

### Смена домена

Повторите команду `domain` с новым доменом, затем перевыпустите SSL:

```bash
sudo /opt/mkt/deploy.sh domain
sudo /opt/mkt/deploy.sh ssl
```

---

## SSL-сертификат

```bash
sudo /opt/mkt/deploy.sh ssl
```

Используется **Let's Encrypt** через certbot. Сертификат:
- Бесплатный
- Выпускается автоматически
- Автопродление через systemd-таймер (каждые 12 часов проверка)
- Nginx автоматически перенаправляет HTTP → HTTPS

---

## Устранение неполадок

### Сайт не открывается

```bash
# Проверить статус всех компонентов
/opt/mkt/deploy.sh status

# Проверить сервис
sudo systemctl status mkt

# Посмотреть логи
sudo journalctl -u mkt -n 50

# Проверить что порт слушает
curl http://127.0.0.1:3000/api/auth/status
```

### Nginx возвращает 502

```bash
# Перезапустить приложение
sudo systemctl restart mkt

# Проверить конфиг nginx
sudo nginx -t
sudo systemctl reload nginx
```

### SSL не работает

```bash
# Проверить что домен резолвится на IP сервера
dig +short your-domain.com

# Перевыпустить сертификат
sudo certbot --nginx -d your-domain.com

# Проверить таймер автопродления
sudo systemctl list-timers certbot.timer
```

### Данные пропали после обновления

Данные хранятся в `/opt/mkt/data/` и не затрагиваются `git pull`.
Бэкапы создаются при каждом `update` в `/opt/mkt-backups/`.

Восстановление:

```bash
ls /opt/mkt-backups/              # Посмотреть бэкапы
cp -r /opt/mkt-backups/data-XXXXXXXX/* /opt/mkt/data/
sudo systemctl restart mkt
```

### Сброс пароля админки

Если забыли пароль:

```bash
sudo rm /opt/mkt/data/auth.json
sudo systemctl restart mkt
```

При следующем входе в админку будет предложено создать новый пароль.
